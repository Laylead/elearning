<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StudyHub Â· Whiteboard</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<style>
/* --- YOUR ORIGINAL CSS (UNCHANGED) --- */
*{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;}
body{background:#f5f7fb;height:100vh;overflow:hidden;}
.container{display:grid;grid-template-columns:1fr 300px;height:100vh;gap:1px;background:#e2e8f0;}
.whiteboard-section{background:white;display:flex;flex-direction:column;}
.toolbar{background:white;padding:15px 20px;border-bottom:2px solid #eef2f6;display:flex;flex-wrap:wrap;gap:15px;align-items:center;}
.tool-group{display:flex;gap:8px;padding:5px;background:#f8fafd;border-radius:40px;}
.tool-btn{width:45px;height:45px;border-radius:40px;border:none;background:transparent;color:#64748b;font-size:18px;cursor:pointer;transition:0.2s;}
.tool-btn:hover{background:#e0e7ff;color:#6366f1;}
.tool-btn.active{background:#6366f1;color:white;}
.color-picker{width:45px;height:45px;border-radius:40px;border:2px solid #e2e8f0;cursor:pointer;}
.canvas-container{flex:1;position:relative;overflow:hidden;background:#f8fafd;}
canvas{display:block;width:100%;height:100%;cursor:crosshair;}
.sidebar{background:white;display:flex;flex-direction:column;overflow:hidden;}
.room-info{padding:20px;border-bottom:2px solid #eef2f6;}
.room-title{font-size:18px;font-weight:700;margin-bottom:5px;}
.room-meta{color:#64748b;font-size:13px;}
.participants-section{padding:20px;border-bottom:2px solid #eef2f6;}
.section-title{font-weight:600;margin-bottom:15px;color:#475569;}
.participant{display:flex;align-items:center;gap:12px;padding:10px;background:#f8fafd;border-radius:40px;margin-bottom:8px;}
.participant-avatar{width:35px;height:35px;background:#6366f1;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:600;font-size:14px;}
.participant-name{flex:1;font-weight:500;}
.chat-section{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.chat-messages{flex:1;overflow-y:auto;padding:20px;}
.message{margin-bottom:15px;}
.message-sender{font-weight:600;font-size:13px;color:#6366f1;margin-bottom:3px;}
.message-text{background:#f8fafd;padding:10px 15px;border-radius:18px;font-size:14px;display:inline-block;max-width:90%;}
.chat-input{padding:15px;border-top:2px solid #eef2f6;display:flex;gap:10px;}
.chat-input input{flex:1;padding:12px;border:2px solid #e2e8f0;border-radius:40px;font-size:14px;}
.chat-input button{width:45px;height:45px;border-radius:50%;border:none;background:#6366f1;color:white;cursor:pointer;}
.audio-controls{display:flex;gap:10px;padding:15px;border-top:2px solid #eef2f6;}
.audio-btn{flex:1;padding:12px;border:none;border-radius:40px;font-weight:600;cursor:pointer;}
#loadingOverlay{position:fixed;top:0;left:0;right:0;bottom:0;background:white;display:flex;align-items:center;justify-content:center;z-index:9999;}
.spinner{border:4px solid #f3f3f3;border-top:4px solid #6366f1;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
</style>
</head>

<body>

<div id="loadingOverlay">
<div style="text-align:center;">
<div class="spinner"></div>
<p id="loadingMessage">Loading room...</p>
</div>
</div>

<div class="container" style="display:none;" id="mainContent">

<div class="whiteboard-section">
<div class="toolbar">
<div class="tool-group">
<button class="tool-btn active" id="drawBtn"><i class="fas fa-pencil-alt"></i></button>
<button class="tool-btn" id="textBtn"><i class="fas fa-font"></i></button>
<button class="tool-btn" id="eraserBtn"><i class="fas fa-eraser"></i></button>
</div>
<div class="tool-group">
<input type="color" id="colorPicker" class="color-picker" value="#6366f1">
<button class="tool-btn" id="clearBtn"><i class="fas fa-trash"></i></button>
</div>
</div>

<div class="canvas-container">
<canvas id="whiteboard"></canvas>
</div>
</div>

<div class="sidebar">
<div class="room-info">
<div class="room-title" id="roomTitle">Loading...</div>
<div class="room-meta" id="roomMeta"></div>
</div>
</div>

</div>

<!-- Firebase -->
<script src="firebase-config.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>

/* ---------------- FIX STARTS HERE ---------------- */

const urlParams = new URLSearchParams(window.location.search);
const roomId = urlParams.get('room');

if (!roomId) {
window.location.href = 'studyrooms.html';
}

if (typeof firebaseConfig === 'undefined') {
document.getElementById('loadingMessage').textContent = 'Firebase config missing';
} else {

if (!firebase.apps.length) {
firebase.initializeApp(firebaseConfig);
}

const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;

auth.onAuthStateChanged(async (user) => {

console.log("Auth user:", user);

if (!user) {
sessionStorage.setItem('returnToRoom', roomId);
window.location.href = 'login.html';
return;
}

currentUser = user;

try {

const roomDoc = await db.collection('activeRooms').doc(roomId).get();

if (!roomDoc.exists) {
throw new Error("Room not found");
}

document.getElementById('roomTitle').textContent =
roomDoc.data().title || "Study Room";

document.getElementById('loadingOverlay').style.display = "none";
document.getElementById('mainContent').style.display = "grid";

initCanvas();

} catch (err) {
console.error(err);
document.getElementById('loadingMessage').textContent = "Error loading room";
}
});

/* --------- WHITEBOARD --------- */

const canvas = document.getElementById("whiteboard");
const ctx = canvas.getContext("2d");

function resizeCanvas(){
canvas.width = canvas.parentElement.clientWidth;
canvas.height = canvas.parentElement.clientHeight;
ctx.fillStyle="white";
ctx.fillRect(0,0,canvas.width,canvas.height);
}
window.addEventListener("resize",resizeCanvas);
resizeCanvas();

let drawing=false;
let lastX=0;
let lastY=0;
let currentColor="#6366f1";

canvas.addEventListener("mousedown",(e)=>{
drawing=true;
const rect=canvas.getBoundingClientRect();
lastX=e.clientX-rect.left;
lastY=e.clientY-rect.top;
});

canvas.addEventListener("mousemove",(e)=>{
if(!drawing) return;
const rect=canvas.getBoundingClientRect();
const x=e.clientX-rect.left;
const y=e.clientY-rect.top;

ctx.beginPath();
ctx.moveTo(lastX,lastY);
ctx.lineTo(x,y);
ctx.strokeStyle=currentColor;
ctx.lineWidth=2;
ctx.stroke();

lastX=x;
lastY=y;
});

canvas.addEventListener("mouseup",()=>drawing=false);
canvas.addEventListener("mouseout",()=>drawing=false);

document.getElementById("colorPicker").addEventListener("input",(e)=>{
currentColor=e.target.value;
});

document.getElementById("clearBtn").addEventListener("click",()=>{
ctx.clearRect(0,0,canvas.width,canvas.height);
ctx.fillStyle="white";
ctx.fillRect(0,0,canvas.width,canvas.height);
});

/* ---------------- FIX ENDS HERE ---------------- */

}

</script>

</body>
</html>
