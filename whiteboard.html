<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyHub · Whiteboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/agora-rtc-sdk-ng@4.15.0/dist/AgoraRTC_N-4.15.0.js"></script>
    <script src="agora.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        
        body { 
            background: #1a1c2c; 
            height: 100vh;
            overflow: hidden;
        }
        
        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr 300px;
            height: 100vh;
            background: #f5f7fb;
        }
        
        /* Sidebar */
        .tools-sidebar {
            background: white;
            border-right: 2px solid #eef2f6;
            padding: 20px;
            overflow-y: auto;
        }
        
        .room-info {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eef2f6;
        }
        
        .room-title {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 5px;
        }
        
        .room-course {
            background: #e0e7ff;
            color: #6366f1;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        
        .tool-section {
            margin-bottom: 25px;
        }
        
        .tool-section h4 {
            color: #64748b;
            font-size: 14px;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .tool-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        
        .tool-btn {
            background: #f8fafd;
            border: 1px solid #edf2f7;
            border-radius: 12px;
            padding: 12px 8px;
            cursor: pointer;
            transition: 0.2s;
            text-align: center;
            color: #475569;
        }
        
        .tool-btn:hover {
            background: #e0e7ff;
            border-color: #6366f1;
            color: #6366f1;
        }
        
        .tool-btn.active {
            background: #6366f1;
            border-color: #6366f1;
            color: white;
        }
        
        .tool-btn i { font-size: 20px; }
        
        .color-picker {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: 0.2s;
        }
        
        .color-option:hover { transform: scale(1.1); }
        .color-option.selected { border-color: #1e293b; }
        
        .math-symbols {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .math-btn {
            background: #f8fafd;
            border: 1px solid #edf2f7;
            border-radius: 12px;
            padding: 10px;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
        }
        
        .math-btn:hover { background: #6366f1; color: white; }
        
        /* Main Whiteboard */
        .whiteboard-area {
            background: #f5f7fb;
            position: relative;
            overflow: hidden;
        }
        
        #whiteboard {
            width: 100%;
            height: 100%;
            cursor: crosshair;
            background: white;
        }
        
        .whiteboard-header {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            pointer-events: none;
        }
        
        .participants-bar {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            border-radius: 40px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            pointer-events: all;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .participant-avatars {
            display: flex;
            align-items: center;
        }
        
        .participant-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #6366f1;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: -8px;
            border: 2px solid white;
        }
        
        .live-audio-indicator {
            background: #ef4444;
            color: white;
            padding: 6px 12px;
            border-radius: 30px;
            font-size: 12px;
            font-weight: 600;
            animation: pulse 1.5s infinite;
        }
        
        /* Chat Sidebar */
        .chat-sidebar {
            background: white;
            border-left: 2px solid #eef2f6;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            padding: 20px;
            border-bottom: 2px solid #eef2f6;
        }
        
        .chat-header h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #1e293b;
        }
        
        .audio-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .audio-btn {
            flex: 1;
            background: #f8fafd;
            border: 1px solid #edf2f7;
            border-radius: 30px;
            padding: 10px;
            cursor: pointer;
            text-align: center;
        }
        
        .audio-btn.active {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }
        
        .audio-btn.speaking {
            animation: speaking 0.5s ease-in-out infinite;
        }
        
        @keyframes speaking {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); background: #10b981; }
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .message {
            background: #f8fafd;
            border-radius: 16px;
            padding: 12px;
        }
        
        .message.own {
            background: #6366f1;
            color: white;
            margin-left: auto;
        }
        
        .message-sender {
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 4px;
            color: #64748b;
        }
        
        .message.own .message-sender { color: rgba(255,255,255,0.8); }
        
        .message-text { font-size: 14px; }
        
        .chat-input-area {
            padding: 20px;
            border-top: 2px solid #eef2f6;
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #eef2f6;
            border-radius: 30px;
            outline: none;
        }
        
        .chat-input:focus { border-color: #6366f1; }
        
        .send-btn {
            background: #6366f1;
            color: white;
            border: none;
            width: 46px;
            height: 46px;
            border-radius: 50%;
            cursor: pointer;
        }
        
        /* Screenshot Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
        }
        
        .modal-overlay.show {
            opacity: 1;
            pointer-events: all;
        }
        
        .modal-content {
            background: white;
            border-radius: 32px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .screenshot-preview {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 16px;
            margin-bottom: 20px;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: white;
            border-radius: 16px;
            padding: 16px 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(400px);
            transition: 0.3s;
            z-index: 2100;
        }
        
        .toast.show { transform: translateX(0); }
        
        @media (max-width: 1200px) {
            .app-container { grid-template-columns: 240px 1fr 260px; }
        }
        
        .back-to-rooms {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: white;
            border: none;
            padding: 12px 24px;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Tools Sidebar -->
        <div class="tools-sidebar">
            <div class="room-info">
                <div class="room-title" id="roomTitle">Loading...</div>
                <div class="room-course" id="roomCourse">Loading...</div>
            </div>
            
            <div class="tool-section">
                <h4>Drawing Tools</h4>
                <div class="tool-buttons">
                    <div class="tool-btn active" id="toolPen" onclick="setTool('pen')"><i class="fas fa-pen"></i></div>
                    <div class="tool-btn" id="toolEraser" onclick="setTool('eraser')"><i class="fas fa-eraser"></i></div>
                    <div class="tool-btn" id="toolText" onclick="setTool('text')"><i class="fas fa-font"></i></div>
                    <div class="tool-btn" id="toolShape" onclick="setTool('shape')"><i class="fas fa-shapes"></i></div>
                </div>
            </div>
            
            <div class="tool-section">
                <h4>Colors</h4>
                <div class="color-picker">
                    <div class="color-option selected" style="background: #000000;" onclick="setColor('#000000')"></div>
                    <div class="color-option" style="background: #6366f1;" onclick="setColor('#6366f1')"></div>
                    <div class="color-option" style="background: #ef4444;" onclick="setColor('#ef4444')"></div>
                    <div class="color-option" style="background: #10b981;" onclick="setColor('#10b981')"></div>
                    <div class="color-option" style="background: #f59e0b;" onclick="setColor('#f59e0b')"></div>
                    <div class="color-option" style="background: #8b5cf6;" onclick="setColor('#8b5cf6')"></div>
                    <div class="color-option" style="background: #ec4899;" onclick="setColor('#ec4899')"></div>
                    <div class="color-option" style="background: #ffffff; border: 2px solid #e2e8f0;" onclick="setColor('#ffffff')"></div>
                </div>
            </div>
            
            <div class="tool-section">
                <h4>Shapes</h4>
                <div class="tool-buttons">
                    <div class="tool-btn" onclick="setShape('rectangle')"><i class="far fa-square"></i></div>
                    <div class="tool-btn" onclick="setShape('circle')"><i class="far fa-circle"></i></div>
                    <div class="tool-btn" onclick="setShape('line')"><i class="fas fa-slash"></i></div>
                    <div class="tool-btn" onclick="setShape('arrow')"><i class="fas fa-arrow-right"></i></div>
                </div>
            </div>
            
            <div class="tool-section">
                <h4>Math Symbols</h4>
                <div class="math-symbols">
                    <div class="math-btn" onclick="insertMathSymbol('∫')">∫</div>
                    <div class="math-btn" onclick="insertMathSymbol('∑')">∑</div>
                    <div class="math-btn" onclick="insertMathSymbol('√')">√</div>
                    <div class="math-btn" onclick="insertMathSymbol('π')">π</div>
                    <div class="math-btn" onclick="insertMathSymbol('∞')">∞</div>
                    <div class="math-btn" onclick="insertMathSymbol('θ')">θ</div>
                    <div class="math-btn" onclick="insertMathSymbol('α')">α</div>
                    <div class="math-btn" onclick="insertMathSymbol('β')">β</div>
                    <div class="math-btn" onclick="insertMathSymbol('γ')">γ</div>
                    <div class="math-btn" onclick="insertMathSymbol('Δ')">Δ</div>
                    <div class="math-btn" onclick="insertMathSymbol('∂')">∂</div>
                    <div class="math-btn" onclick="insertMathSymbol('∇')">∇</div>
                </div>
            </div>
            
            <div class="tool-section">
                <h4>Actions</h4>
                <div class="tool-buttons">
                    <div class="tool-btn" onclick="clearCanvas()"><i class="fas fa-trash"></i></div>
                    <div class="tool-btn" onclick="takeScreenshot()"><i class="fas fa-camera"></i></div>
                    <div class="tool-btn" onclick="downloadCanvas()"><i class="fas fa-download"></i></div>
                    <div class="tool-btn" onclick="toggleGrid()"><i class="fas fa-border-all"></i></div>
                </div>
            </div>
        </div>
        
        <!-- Whiteboard Area -->
        <div class="whiteboard-area">
            <canvas id="whiteboard"></canvas>
            
            <div class="whiteboard-header">
                <div class="participants-bar">
                    <div class="participant-avatars" id="participantAvatars"></div>
                    <span id="participantCount">0 participants</span>
                    <span class="live-audio-indicator"><i class="fas fa-circle"></i> LIVE AUDIO</span>
                </div>
            </div>
        </div>
        
        <!-- Chat Sidebar -->
        <div class="chat-sidebar">
            <div class="chat-header">
                <h3><i class="fas fa-comments"></i> Live Chat</h3>
                <div class="audio-controls">
                    <button class="audio-btn" id="micBtn" onclick="toggleMicrophone()">
                        <i class="fas fa-microphone"></i> Mic
                    </button>
                    <button class="audio-btn" id="speakerBtn" onclick="toggleSpeaker()">
                        <i class="fas fa-volume-up"></i> Speaker
                    </button>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #64748b;">
                    <span id="speakerIndicator">No one speaking</span>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages"></div>
            
            <div class="chat-input-area">
                <input type="text" class="chat-input" id="chatInput" placeholder="Type a question..." onkeypress="handleChatKeyPress(event)">
                <button class="send-btn" onclick="sendChatMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>
    
    <button class="back-to-rooms" onclick="leaveRoom()">
        <i class="fas fa-arrow-left"></i> Back to Rooms
    </button>
    
    <!-- Screenshot Modal -->
    <div class="modal-overlay" id="screenshotModal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">Screenshot Captured</h2>
            <img id="screenshotPreview" class="screenshot-preview" src="" alt="Screenshot">
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button class="audio-btn" onclick="closeScreenshotModal()">Close</button>
                <button class="audio-btn" style="background: #6366f1; color: white;" onclick="downloadScreenshot()">Download</button>
            </div>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast">
        <i class="fas" id="toastIcon"></i>
        <span id="toastMessage"></span>
    </div>
    
    <script>
        // Initialize Firebase
        if (typeof firebaseConfig === 'undefined') {
            window.location.href = 'login.html';
        }
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Room state
        let currentUser = null;
        let roomId = null;
        let roomData = null;
        let isCreator = false;
        
        // Whiteboard state
        const canvas = document.getElementById('whiteboard');
        const ctx = canvas.getContext('2d');
        let drawing = false;
        let currentTool = 'pen';
        let currentColor = '#000000';
        let currentShape = 'rectangle';
        let lineWidth = 2;
        let lastX = 0, lastY = 0;
        let startX, startY;
        
        // Audio state
        let agoraClient = null;
        let localAudioTrack = null;
        let isMicOn = false;
        let isSpeakerOn = true;
        let remoteUsers = new Map();
        
        // Resize canvas
        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            redrawCanvas();
        }
        
        window.addEventListener('resize', resizeCanvas);
        
        // Auth check
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            currentUser = user;
            
            // Get room ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            roomId = urlParams.get('room');
            
            if (!roomId) {
                showToast('No room specified', 'error');
                setTimeout(() => window.location.href = 'studyrooms.html', 2000);
                return;
            }
            
            await loadRoomData();
            await loadParticipants();
            setupRealtimeWhiteboard();
            setupRealtimeChat();
            initAgora();
            resizeCanvas();
        });
        
        // Load room data
        async function loadRoomData() {
            try {
                const doc = await db.collection('activeRooms').doc(roomId).get();
                
                if (!doc.exists) {
                    showToast('Room not found', 'error');
                    setTimeout(() => window.location.href = 'studyrooms.html', 2000);
                    return;
                }
                
                roomData = doc.data();
                isCreator = roomData.createdBy === currentUser.uid;
                
                document.getElementById('roomTitle').textContent = roomData.title || 'Untitled Room';
                document.getElementById('roomCourse').textContent = roomData.course || 'General';
                
                // Add user to participants if not already
                if (!roomData.participants?.includes(currentUser.uid)) {
                    await db.collection('activeRooms').doc(roomId).update({
                        participants: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                    });
                }
            } catch (error) {
                showToast('Error loading room', 'error');
            }
        }
        
        // Load participants
        async function loadParticipants() {
            try {
                const doc = await db.collection('activeRooms').doc(roomId).get();
                const participants = doc.data()?.participants || [];
                
                document.getElementById('participantCount').textContent = `${participants.length} participants`;
                
                // Load user details for avatars
                const avatarsHtml = participants.slice(0, 5).map((uid, i) => {
                    return `<div class="participant-avatar" style="background: hsl(${i * 40}, 70%, 60%);">${uid.substring(0, 2).toUpperCase()}</div>`;
                }).join('');
                
                document.getElementById('participantAvatars').innerHTML = avatarsHtml;
            } catch (error) {
                console.error('Error loading participants:', error);
            }
        }
        
        // Setup real-time whiteboard
        function setupRealtimeWhiteboard() {
            db.collection('whiteboardDrawings').doc(roomId).collection('strokes')
                .orderBy('timestamp')
                .onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const stroke = change.doc.data();
                            if (stroke.userId !== currentUser.uid) {
                                drawRemoteStroke(stroke);
                            }
                        }
                    });
                });
        }
        
        // Setup real-time chat
        function setupRealtimeChat() {
            db.collection('roomChat').doc(roomId).collection('messages')
                .orderBy('timestamp')
                .limit(50)
                .onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            displayMessage(change.doc.data());
                        }
                    });
                });
        }
        
        // Initialize Agora
        async function initAgora() {
            try {
                agoraClient = initAgoraClient();
                
                // Set client role based on user
                await agoraClient.setClientRole(isCreator ? 'host' : 'audience');
                
                // Join channel
                const token = await generateAgoraToken(roomId, currentUser.uid);
                await joinAgoraChannel(agoraClient, roomId, token, currentUser.uid);
                
                // Setup listeners
                setupAgoraListeners(
                    agoraClient,
                    (user) => {
                        showToast(`${user.uid} joined audio`, 'success');
                        updateSpeakerIndicator();
                    },
                    (user) => {
                        showToast(`${user.uid} left audio`, 'success');
                        remoteUsers.delete(user.uid);
                        updateSpeakerIndicator();
                    }
                );
                
                showToast('Connected to audio channel', 'success');
            } catch (error) {
                console.error('Agora init error:', error);
                showToast('Audio connection failed', 'error');
            }
        }
        
        // Toggle microphone
        window.toggleMicrophone = async function() {
            if (!agoraClient) return;
            
            try {
                if (!isMicOn) {
                    localAudioTrack = await createLocalAudioTrack();
                    await publishAudio(agoraClient, localAudioTrack);
                    
                    // Monitor audio level
                    localAudioTrack.on('volume-indicator', (volumes) => {
                        if (volumes[0].volume > 10) {
                            document.getElementById('micBtn').classList.add('speaking');
                        } else {
                            document.getElementById('micBtn').classList.remove('speaking');
                        }
                    });
                    
                    document.getElementById('micBtn').innerHTML = '<i class="fas fa-microphone-slash"></i> Mute';
                    isMicOn = true;
                } else {
                    await localAudioTrack.close();
                    document.getElementById('micBtn').innerHTML = '<i class="fas fa-microphone"></i> Mic';
                    isMicOn = false;
                }
            } catch (error) {
                showToast('Error toggling microphone', 'error');
            }
        };
        
        // Toggle speaker
        window.toggleSpeaker = function() {
            isSpeakerOn = !isSpeakerOn;
            document.getElementById('speakerBtn').innerHTML = isSpeakerOn ? 
                '<i class="fas fa-volume-up"></i> Speaker' : 
                '<i class="fas fa-volume-mute"></i> Muted';
            
            // Mute/unmute all remote audio
            remoteUsers.forEach(user => {
                if (user.audioTrack) {
                    isSpeakerOn ? user.audioTrack.play() : user.audioTrack.stop();
                }
            });
        };
        
        // Update speaker indicator
        function updateSpeakerIndicator() {
            const speakingUsers = remoteUsers.size;
            document.getElementById('speakerIndicator').textContent = 
                speakingUsers > 0 ? `${speakingUsers} speaking` : 'No one speaking';
        }
        
        // Drawing functions
        function startDrawing(e) {
            drawing = true;
            const pos = getCanvasCoordinates(e);
            startX = pos.x;
            startY = pos.y;
            
            if (currentTool === 'pen') {
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
            }
        }
        
        function draw(e) {
            if (!drawing) return;
            
            const pos = getCanvasCoordinates(e);
            
            if (currentTool === 'pen') {
                ctx.strokeStyle = currentColor;
                ctx.lineWidth = lineWidth;
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
                
                // Send stroke to Firebase
                saveStroke({
                    type: 'pen',
                    x: pos.x,
                    y: pos.y,
                    color: currentColor,
                    width: lineWidth,
                    timestamp: Date.now()
                });
            }
        }
        
        function stopDrawing() {
            if (drawing && currentTool === 'shape' && startX && startY) {
                const pos = getCanvasCoordinates(event);
                drawShape(startX, startY, pos.x, pos.y);
            }
            drawing = false;
        }
        
        function drawShape(x1, y1, x2, y2) {
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = lineWidth;
            
            switch(currentShape) {
                case 'rectangle':
                    ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
                    break;
                case 'circle':
                    const radius = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
                    ctx.beginPath();
                    ctx.arc(x1, y1, radius, 0, 2 * Math.PI);
                    ctx.stroke();
                    break;
                case 'line':
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.stroke();
                    break;
            }
            
            // Save shape
            saveStroke({
                type: 'shape',
                shape: currentShape,
                x1: x1,
                y1: y1,
                x2: x2,
                y2: y2,
                color: currentColor,
                width: lineWidth,
                timestamp: Date.now()
            });
        }
        
        // Save stroke to Firebase
        async function saveStroke(strokeData) {
            try {
                await db.collection('whiteboardDrawings').doc(roomId).collection('strokes').add({
                    ...strokeData,
                    userId: currentUser.uid,
                    roomId: roomId
                });
            } catch (error) {
                console.error('Error saving stroke:', error);
            }
        }
        
        // Draw remote stroke
        function drawRemoteStroke(stroke) {
            if (stroke.type === 'pen') {
                ctx.strokeStyle = stroke.color;
                ctx.lineWidth = stroke.width;
                ctx.lineTo(stroke.x, stroke.y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(stroke.x, stroke.y);
            } else if (stroke.type === 'shape') {
                ctx.strokeStyle = stroke.color;
                ctx.lineWidth = stroke.width;
                drawShape(stroke.x1, stroke.y1, stroke.x2, stroke.y2);
            }
        }
        
        // Get canvas coordinates
        function getCanvasCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            let x, y;
            if (e.touches) {
                x = (e.touches[0].clientX - rect.left) * scaleX;
                y = (e.touches[0].clientY - rect.top) * scaleY;
            } else {
                x = (e.clientX - rect.left) * scaleX;
                y = (e.clientY - rect.top) * scaleY;
            }
            
            return { x, y };
        }
        
        // Tool functions
        window.setTool = function(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tool${tool.charAt(0).toUpperCase() + tool.slice(1)}`).classList.add('active');
        };
        
        window.setColor = function(color) {
            currentColor = color;
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
            event.target.classList.add('selected');
        };
        
        window.setShape = function(shape) {
            currentShape = shape;
            setTool('shape');
        };
        
        window.insertMathSymbol = function(symbol) {
            setTool('text');
            // Insert symbol at cursor position
            saveStroke({
                type: 'text',
                text: symbol,
                x: lastX,
                y: lastY,
                color: currentColor,
                timestamp: Date.now()
            });
        };
        
        // Clear canvas
        window.clearCanvas = async function() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Clear Firebase strokes
            const strokes = await db.collection('whiteboardDrawings').doc(roomId).collection('strokes').get();
            strokes.docs.forEach(doc => doc.ref.delete());
        };
        
        // Redraw canvas
        async function redrawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const strokes = await db.collection('whiteboardDrawings').doc(roomId).collection('strokes')
                .orderBy('timestamp')
                .get();
            
            strokes.forEach(doc => drawRemoteStroke(doc.data()));
        }
        
        // Take screenshot
        window.takeScreenshot = function() {
            const dataURL = canvas.toDataURL('image/png');
            document.getElementById('screenshotPreview').src = dataURL;
            document.getElementById('screenshotModal').classList.add('show');
        };
        
        window.closeScreenshotModal = function() {
            document.getElementById('screenshotModal').classList.remove('show');
        };
        
        window.downloadScreenshot = function() {
            const dataURL = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = `whiteboard-${roomId}-${Date.now()}.png`;
            link.href = dataURL;
            link.click();
        };
        
        // Download canvas
        window.downloadCanvas = function() {
            const dataURL = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = `whiteboard-${roomId}-${Date.now()}.png`;
            link.href = dataURL;
            link.click();
        };
        
        // Toggle grid
        window.toggleGrid = function() {
            // Implement grid overlay
        };
        
        // Chat functions
        window.sendChatMessage = async function() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            try {
                await db.collection('roomChat').doc(roomId).collection('messages').add({
                    userId: currentUser.uid,
                    userName: currentUser.displayName || 'Student',
                    text: text,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                input.value = '';
            } catch (error) {
                showToast('Error sending message', 'error');
            }
        };
        
        window.handleChatKeyPress = function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        };
        
        function displayMessage(message) {
            const messagesEl = document.getElementById('chatMessages');
            const isOwn = message.userId === currentUser.uid;
            
            const messageEl = document.createElement('div');
            messageEl.className = `message ${isOwn ? 'own' : ''}`;
            messageEl.innerHTML = `
                <div class="message-sender">${message.userName}</div>
                <div class="message-text">${message.text}</div>
            `;
            
            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        
        // Leave room
        window.leaveRoom = async function() {
            try {
                // Remove user from participants
                await db.collection('activeRooms').doc(roomId).update({
                    participants: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
                });
                
                // Leave Agora channel
                if (agoraClient) {
                    await leaveAgoraChannel(agoraClient);
                }
                
                window.location.href = 'studyrooms.html';
            } catch (error) {
                window.location.href = 'studyrooms.html';
            }
        };
        
        // Toast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toastIcon');
            const toastMessage = document.getElementById('toastMessage');
            
            toast.className = `toast ${type}`;
            toastIcon.className = `fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}`;
            toastMessage.textContent = message;
            
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        // Event listeners
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseleave', stopDrawing);
        
        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', stopDrawing);
    </script>
</body>
</html>